# TAPAssure: A Verification-Driven Framework for Safe LLM-Based Automation in Smart Homes

TAPAssure is a framework that ensures the safety and reliability of smart home automation rules generated by Large Language Models (LLMs). It integrates LLM-based rule generation with formal verification to create a closed-loop system that automatically detects and corrects errors, unsafe behaviors, and syntax issues before deployment.

This repository contains the source code and evaluation dataset for the research paper, "TAPAssure: A Verification-Driven Framework for Safe LLM-Based Automation in Smart Homes."

## Features

* **Formal Verification:** Uses the NuSMV model checker to formally verify that LLM-generated rules comply with user-defined safety properties.
* **Iterative Feedback Loop:** Automatically translates formal counterexamples from the model checker into natural language prompts, guiding the LLM to correct its own errors.
* **Context-Aware Generation:** Integrates with the SmartThings API to resolve ambiguous user commands and ground automation rules in the real-world device context.
* **Automated Syntax Correction:** Iteratively checks and refines the generated NuSMV model code until it is syntactically correct and ready for verification.

## How It Works

TAPAssure operates in two primary phases, each handled by specific Python scripts in this repository.

### Process 1: Context Verification and Initial Model Generation

This process focuses on understanding the user's command and generating a syntactically correct formal model.

1.  **User Input:** The user provides a scenario and safety properties in natural language.
2.  **Context Verification:** The LLM checks for ambiguous device references (e.g., "the living room light"). If found, it can query the SmartThings API to get a specific list of devices.
3.  **Initial Model Generation:** The LLM translates the user's request into an initial NuSMV model.
4.  **Syntax Checking:** The framework repeatedly attempts to compile the model, feeding any syntax errors back to the LLM until a valid model is produced.

#### Python Files for Process 1:

* `main.py`: The main entry point to run the entire TAPAssure process. It orchestrates the calls to other modules. To run this process, you would typically start here.
* `llm_handler.py`: Contains the logic for interacting with the LLM APIs (e.g., Llama3.3, Qwen2.5). It is responsible for sending prompts and receiving generated code.
* `nusmv_checker.py`: Includes the function to run the NuSMV compiler and capture syntax errors from its output.

### Process 2: Iterative Model Regeneration to Minimize Violations

This is the core verification loop that ensures the rules are not just correct, but safe.

1.  **Formal Verification:** The syntactically valid NuSMV model is checked against the LTL safety properties.
2.  **Counterexample Generation:** If a violation is found, NuSMV produces a counterexample trace showing how the unsafe state occurs.
3.  **Counterexample-to-Prompt Translation:** TAPAssure parses this formal trace and translates it into a clear, corrective prompt in natural language.
4.  **Iterative Refinement:** This new prompt is sent to the LLM, which regenerates the model. This loop continues until the model checker confirms all safety properties are satisfied.

#### Python Files for Process 2:

* `main.py`: As the orchestrator, this file initiates the verification loop after a syntactically valid model is created.
* `nusmv_checker.py`: Contains the core logic for running the NuSMV model checker, identifying safety violations, and parsing the counterexample output.
* `prompt_generator.py`: Responsible for constructing the refined, corrective prompts based on the parsed counterexamples, guiding the LLM to fix the safety violation.

## How to Run the Project

To run TAPAssure, follow these steps:

1.  **Clone the repository:**
    ```bash
    git clone [https://github.com/huuhuannt1998/tapassure.git](https://github.com/huuhuannt1998/tapassure.git)
    cd tapassure
    ```

2.  **Set up the environment:**
    It is recommended to use a virtual environment.
    ```bash
    python -m venv venv
    source venv/bin/activate  # On Windows, use `venv\Scripts\activate`
    ```

3.  **Install dependencies:**
    Ensure you have the NuSMV model checker installed and available in your system's PATH. Then, install the required Python packages.
    ```bash
    pip install -r requirements.txt
    ```

4.  **Configure API Keys:**
    You will need API keys for the Large Language Models you intend to use. Set them as environment variables or configure them within `llm_handler.py`.
    ```bash
    export OPENAI_API_KEY="your-api-key-here"
    ```

5.  **Run the main script:**
    Execute the main script to start the TAPAssure process. You can configure the input scenarios and safety properties within the script or modify it to accept command-line arguments.
    ```bash
    python main.py
    ```
    The script will output the results of the verification process, including the number of iterations required to achieve a safe and correct model.


